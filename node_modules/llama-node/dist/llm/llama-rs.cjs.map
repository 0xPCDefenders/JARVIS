{"version":3,"sources":["../../src/llm/llama-rs.ts"],"sourcesContent":["import {\n    EmbeddingResultType,\n    InferenceResultType,\n    LLama,\n    LLamaConfig,\n    LLamaInferenceArguments,\n} from \"@llama-node/core\";\nimport type { ILLM } from \"../llm\";\n\nexport class LLamaRS\n    implements\n        ILLM<\n            LLama,\n            LLamaConfig,\n            LLamaInferenceArguments,\n            LLamaInferenceArguments,\n            string\n        >\n{\n    instance!: LLama;\n\n    load(config: LLamaConfig) {\n        this.instance = LLama.create(config);\n    }\n\n    async createCompletion(\n        params: LLamaInferenceArguments,\n        callback: (data: { token: string; completed: boolean }) => void\n    ): Promise<boolean> {\n        let completed = false;\n        const errors: string[] = [];\n        return new Promise<boolean>((res, rej) => {\n            this.instance.inference(params, (response) => {\n                switch (response.type) {\n                    case InferenceResultType.Data: {\n                        const data = {\n                            token: response.data!.token,\n                            completed: !!response.data!.completed,\n                        };\n                        if (data.completed) {\n                            completed = true;\n                        }\n                        callback(data);\n                        break;\n                    }\n                    case InferenceResultType.Error: {\n                        if (errors.length) {\n                            rej(new Error(errors.join(\"\\n\")));\n                        } else {\n                            res(completed);\n                        }\n                        break;\n                    }\n                    case InferenceResultType.End: {\n                        errors.push(response.message ?? \"Unknown error\");\n                        break;\n                    }\n                }\n            });\n        });\n    }\n\n    async getEmbedding(params: LLamaInferenceArguments): Promise<number[]> {\n        return new Promise<number[]>((res, rej) => {\n            this.instance.getWordEmbeddings(params, (response) => {\n                switch (response.type) {\n                    case EmbeddingResultType.Data:\n                        res(response.data ?? []);\n                        break;\n                    case EmbeddingResultType.Error:\n                        rej(response.message);\n                        break;\n                }\n            });\n        });\n    }\n\n    async getDefaultEmbedding(text: string): Promise<number[]> {\n        return this.getEmbedding({\n            nThreads: 4,\n            numPredict: 1024,\n            topK: 40,\n            topP: 0.1,\n            temp: 0.1,\n            repeatPenalty: 1,\n            prompt: text,\n        });\n    }\n\n    async tokenize(params: string): Promise<number[]> {\n        return new Promise<number[]>((res) => {\n            this.instance.tokenize(params, (response) => {\n                res(response.data);\n            });\n        });\n    }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAMO;AAGA,IAAM,UAAN,MASP;AAAA,EAGI,KAAK,QAAqB;AACtB,SAAK,WAAW,kBAAM,OAAO,MAAM;AAAA,EACvC;AAAA,EAEM,iBACF,QACA,UACgB;AAAA;AAChB,UAAI,YAAY;AAChB,YAAM,SAAmB,CAAC;AAC1B,aAAO,IAAI,QAAiB,CAAC,KAAK,QAAQ;AACtC,aAAK,SAAS,UAAU,QAAQ,CAAC,aAAa;AAhC1D;AAiCgB,kBAAQ,SAAS,MAAM;AAAA,YACnB,KAAK,gCAAoB,MAAM;AAC3B,oBAAM,OAAO;AAAA,gBACT,OAAO,SAAS,KAAM;AAAA,gBACtB,WAAW,CAAC,CAAC,SAAS,KAAM;AAAA,cAChC;AACA,kBAAI,KAAK,WAAW;AAChB,4BAAY;AAAA,cAChB;AACA,uBAAS,IAAI;AACb;AAAA,YACJ;AAAA,YACA,KAAK,gCAAoB,OAAO;AAC5B,kBAAI,OAAO,QAAQ;AACf,oBAAI,IAAI,MAAM,OAAO,KAAK,IAAI,CAAC,CAAC;AAAA,cACpC,OAAO;AACH,oBAAI,SAAS;AAAA,cACjB;AACA;AAAA,YACJ;AAAA,YACA,KAAK,gCAAoB,KAAK;AAC1B,qBAAO,MAAK,cAAS,YAAT,YAAoB,eAAe;AAC/C;AAAA,YACJ;AAAA,UACJ;AAAA,QACJ,CAAC;AAAA,MACL,CAAC;AAAA,IACL;AAAA;AAAA,EAEM,aAAa,QAAoD;AAAA;AACnE,aAAO,IAAI,QAAkB,CAAC,KAAK,QAAQ;AACvC,aAAK,SAAS,kBAAkB,QAAQ,CAAC,aAAa;AAhElE;AAiEgB,kBAAQ,SAAS,MAAM;AAAA,YACnB,KAAK,gCAAoB;AACrB,mBAAI,cAAS,SAAT,YAAiB,CAAC,CAAC;AACvB;AAAA,YACJ,KAAK,gCAAoB;AACrB,kBAAI,SAAS,OAAO;AACpB;AAAA,UACR;AAAA,QACJ,CAAC;AAAA,MACL,CAAC;AAAA,IACL;AAAA;AAAA,EAEM,oBAAoB,MAAiC;AAAA;AACvD,aAAO,KAAK,aAAa;AAAA,QACrB,UAAU;AAAA,QACV,YAAY;AAAA,QACZ,MAAM;AAAA,QACN,MAAM;AAAA,QACN,MAAM;AAAA,QACN,eAAe;AAAA,QACf,QAAQ;AAAA,MACZ,CAAC;AAAA,IACL;AAAA;AAAA,EAEM,SAAS,QAAmC;AAAA;AAC9C,aAAO,IAAI,QAAkB,CAAC,QAAQ;AAClC,aAAK,SAAS,SAAS,QAAQ,CAAC,aAAa;AACzC,cAAI,SAAS,IAAI;AAAA,QACrB,CAAC;AAAA,MACL,CAAC;AAAA,IACL;AAAA;AACJ;","names":[]}